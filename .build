#!/usr/bin/python3

import os
import platform
import sys

platform = platform.system().lower()
print("Platform is " + str(platform))

debug = False

if len(sys.argv) > 1 and (sys.argv[1] == "-d" or sys.argv[1] == "--debug"):
	debug = True

if not os.system("cd core && cargo build --release && cd .."):
    if "windows" in platform:
        print("Found windows OS")
        os.system("mkdir -p build/package/windows/lib")
    if "linux" in platform:
        print("Found linux OS")

        # Create folder
        os.system("mkdir -p build/package/linux/")
        os.system("mkdir -p build/package/linux/plugins/")
        os.system("mkdir -p build/package/linux/plugins_shadow/")

        # Copy executables
        # os.system("cp build/bin/standalone/debug/standalone build/package/linux/.")
        #os.system("cp build/debug/plugin build/package/linux/.")
        # os.system("cp src/workstation/build/workstation_artefacts/Standalone/workstation build/package/linux/.")

        # Copy libraries
        # os.system("cp -r build/bin/lib/release/lib/ build/package/linux/.")
        # os.system("cp build/bin/lib/release/libtonevision_core.so build/package/linux/lib/.")
        # os.system("mkdir build/package/linux/lib/lib")
        # os.system("mv build/package/linux/lib/libflutter_linux_gtk.so build/package/linux/lib/lib/.")

        # Copy data
        # os.system("cp -r build/bin/lib/release/data/ build/package/linux/.")

    if "darwin" in platform:
        if debug:
            if not os.system("cd flutter && flutter build macos --debug && cd .."):
                print("Building MacOS in debug mode")

                os.system("mkdir -p build/out/host/debug")

                if not os.system("cd build/out/host/debug && cmake ../../../../host/. -DCMAKE_BUILD_TYPE=Debug && make"):
                    print("Host build suceeded")
                    # Package
                    os.system("mkdir -p build/package/macos/standalone/")
                    # Release
                    os.system("mkdir -p build/release/macos")
                    print("Done")
                else:
                    print("Host build failed")
        else:
            if not os.system("cd flutter && flutter build macos --release && cd .."):
                print("Building MacOS in release mode")

                os.system("mkdir -p build/out/host/release")

                if not os.system("cd build/out/host/release && cmake ../../../../host/. -DCMAKE_BUILD_TYPE=Release && make"):
                    print("Host build suceeded")
                    # Package
                    os.system("mkdir -p build/package/macos/standalone")
                    # Release
                    os.system("mkdir -p build/release/macos")
                    print("Done")
                else:
                    print("Host build failed")
            

os.system("cd protocol && ./build.sh")

