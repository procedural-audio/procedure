name: Build Procedure

# Controls when the workflow will run
on:
  push:
    tags:
      - 'v*'

env:
  LATEST_RELEASE_TAG: latest

jobs:
  # Ensure the GitHub Release for this tag exists so downstream jobs can attach artifacts
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure release exists for tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TARGET_TAG="${{ github.ref_name }}"
          LATEST_TAG="${{ env.LATEST_RELEASE_TAG }}"

          if gh release view "$TARGET_TAG" >/dev/null 2>&1; then
            echo "Release $TARGET_TAG already exists"
          else
            gh release create "$TARGET_TAG" --generate-notes --target "$GITHUB_SHA"
          fi

          if gh release view "$LATEST_TAG" >/dev/null 2>&1; then
            gh release edit "$LATEST_TAG" --target "$GITHUB_SHA" --notes "Latest build synced from $TARGET_TAG"
          else
            gh release create "$LATEST_TAG" --target "$GITHUB_SHA" --title "Latest Procedure build" --notes "Latest build synced from $TARGET_TAG"
          fi

  # Job to build the macOS application
  build-macos:
    needs: prepare-release
    runs-on: macos-latest # Use the latest available macOS runner
    defaults:
      run:
        working-directory: flutter
    env:
      MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
      MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
      MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
      NOTARIZATION_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
      NOTARIZATION_KEY_ISSUER: ${{ secrets.ASC_API_KEY_ISSUER }}
      NOTARIZATION_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}

    steps:
      # Checks-outs your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Sets up the Flutter SDK for use in the workflow
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # Use the stable channel of Flutter
          flutter-version-file: flutter/pubspec.yaml
          cache: true

      - name: Install signing certificate
        if: ${{ env.MACOS_CERT_P12 != '' && env.MACOS_CERT_PASSWORD != '' }}
        run: |
          CERT_PATH="$RUNNER_TEMP/macos_signing_cert.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/build-signing.keychain-db"
          echo "$MACOS_CERT_P12" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"
          echo "CODESIGN_KEYCHAIN=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      # Gets the Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Builds the macOS release application
      - name: Build macOS release
        run: flutter build macos --release

      - name: Codesign Procedure.app
        if: ${{ env.MACOS_SIGNING_IDENTITY != '' }}
        run: |
          APP_PATH="build/macos/Build/Products/Release/procedure.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Expected app bundle at $APP_PATH was not found."
            exit 1
          fi
          codesign --force --deep --options runtime --sign "$MACOS_SIGNING_IDENTITY" "$APP_PATH"
          codesign --verify --deep --strict "$APP_PATH"

      # Package the release build
      - name: Package macOS release
        run: |
          cd build/macos/Build/Products/Release
          hdiutil create -volname "procedure" -srcfolder procedure.app -ov -format UDZO ../../../../procedure-macos.dmg

      - name: Codesign disk image
        if: ${{ env.MACOS_SIGNING_IDENTITY != '' }}
        run: |
          DMG_PATH="build/procedure-macos.dmg"
          if [ ! -f "$DMG_PATH" ]; then
            echo "Expected DMG at $DMG_PATH was not found."
            exit 1
          fi
          codesign --force --sign "$MACOS_SIGNING_IDENTITY" "$DMG_PATH"

      - name: Notarize disk image
        if: ${{ env.NOTARIZATION_KEY_ID != '' && env.NOTARIZATION_KEY_ISSUER != '' && env.NOTARIZATION_KEY_P8 != '' }}
        run: |
          DMG_PATH="build/procedure-macos.dmg"
          API_KEY_FILE="$RUNNER_TEMP/AuthKey_${{ env.NOTARIZATION_KEY_ID }}.p8"
          printf '%s' "$NOTARIZATION_KEY_P8" > "$API_KEY_FILE"
          xcrun notarytool submit "$DMG_PATH" \
            --key "$API_KEY_FILE" \
            --key-id "${{ env.NOTARIZATION_KEY_ID }}" \
            --issuer "${{ env.NOTARIZATION_KEY_ISSUER }}" \
            --wait

      - name: Staple notarization ticket
        if: ${{ env.NOTARIZATION_KEY_ID != '' && env.NOTARIZATION_KEY_ISSUER != '' && env.NOTARIZATION_KEY_P8 != '' }}
        run: |
          DMG_PATH="build/procedure-macos.dmg"
          xcrun stapler staple "$DMG_PATH"

      # Upload to GitHub release
      - name: Upload to GitHub Release
        run: |
          gh release upload ${{ github.ref_name }} build/procedure-macos.dmg --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to static latest release
        run: |
          gh release upload "${{ env.LATEST_RELEASE_TAG }}" build/procedure-macos.dmg --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job to build the Windows application
  build-windows-x64:
    needs: prepare-release
    runs-on: windows-latest
    defaults:
      run:
        working-directory: flutter

    steps:
      # Checks-outs your repository
      - uses: actions/checkout@v4

      # Sets up the Flutter SDK
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version-file: flutter/pubspec.yaml
          cache: true

      # Gets the Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Builds the Windows release application
      - name: Build Windows release
        run: flutter build windows --release

      # Package the release build
      - name: Package Windows release
        run: |
          cd build/windows/x64/runner/Release
          7z a ../../../../procedure-windows-x64.zip .

      # Upload to GitHub release
      - name: Upload to GitHub Release
        run: |
          gh release upload ${{ github.ref_name }} build/procedure-windows-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to static latest release
        run: |
          gh release upload "${{ env.LATEST_RELEASE_TAG }}" build/procedure-windows-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job to build the Linux x64 application
  build-linux-x64:
    needs: prepare-release
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter

    steps:
      # Checks-outs your repository
      - uses: actions/checkout@v4

      # Sets up the Flutter SDK
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version-file: flutter/pubspec.yaml
          cache: true

      # Install Linux dependencies
      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libasound2-dev libjack-jackd2-dev
          sudo apt-get install -y libwebkit2gtk-4.0-dev || sudo apt-get install -y libwebkit2gtk-4.1-dev
          if ! pkg-config --exists webkit2gtk-4.0; then
            if pkg-config --exists webkit2gtk-4.1; then
              pc_dir=$(pkg-config --variable=pcfiledir webkit2gtk-4.1)
              sudo ln -sf "${pc_dir}/webkit2gtk-4.1.pc" "${pc_dir}/webkit2gtk-4.0.pc"
            fi
          fi
      # Gets the Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Builds the Linux release application
      - name: Build Linux release
        run: flutter build linux --release

      # Package the release build
      - name: Package Linux release
        run: |
          cd build/linux/x64/release/
          zip -r ../../../procedure-linux-x64.zip bundle
      - name: Build Snapcraft package
        id: snapcraft
        uses: snapcore/action-build@v1
        with:
          path: snap
          snapcraft-args: "--destructive-mode"
      - name: Copy Snap artifact
        run: |
          SNAP_PATH="${{ steps.snapcraft.outputs.snap }}"
          if [ -z "$SNAP_PATH" ] || [ ! -f "$SNAP_PATH" ]; then
            echo "snapcore/action-build did not output a snap artifact."
            exit 1
          fi
          cp "$SNAP_PATH" build/procedure-linux-amd64.snap

      # Upload to GitHub release
      - name: Upload to GitHub Release
        run: |
          gh release upload ${{ github.ref_name }} build/procedure-linux-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to static latest release
        run: |
          gh release upload "${{ env.LATEST_RELEASE_TAG }}" build/procedure-linux-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Snapcraft package to GitHub Release
        run: |
          gh release upload ${{ github.ref_name }} build/procedure-linux-amd64.snap --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Snapcraft package to static latest release
        run: |
          gh release upload "${{ env.LATEST_RELEASE_TAG }}" build/procedure-linux-amd64.snap --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job to build the Linux ARM64 application
  # build-linux-arm64:
  #   runs-on: ubuntu-24.04-arm
  #   defaults:
  #     run:
  #       working-directory: flutter

  #   steps:
  #     # Checks-outs your repository
  #     - uses: actions/checkout@v4

  #     # Sets up the Flutter SDK
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         channel: 'stable'
  #         flutter-version-file: flutter/pubspec.yaml
  #         cache: true

  #     # Install Linux dependencies
  #     - name: Install Linux dependencies
  #       run: |
  #         sudo apt-get update -y
  #         sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

  #     # Gets the Flutter dependencies
  #     - name: Get Flutter dependencies
  #       run: flutter pub get

  #     # Builds the Linux release application
  #     - name: Build Linux release
  #       run: flutter build linux --release

  #     # Package the release build
  #     - name: Package Linux release
  #       run: |
  #         cd build/linux/arm64/release/
  #         zip -r ../../../procedure-linux-arm64.zip bundle

  #     # Upload to GitHub release
  #     - name: Upload to GitHub Release
  #       run: |
  #         gh release upload ${{ github.ref_name }} build/procedure-linux-arm64.zip --clobber
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # # Job to build the Android APK
  # build-android:
  #   runs-on: ubuntu-latest # Use the latest available Ubuntu runner

  #   steps:
  #     # Checks-outs your repository
  #     - uses: actions/checkout@v4

  #     # Sets up the Flutter SDK
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         channel: 'stable'
  #         flutter-version-file: flutter/pubspec.yaml
  #         cache: true

  #     # Gets the Flutter dependencies
  #     - name: Get Flutter dependencies
  #       run: flutter pub get

  #     # Builds the Android APK
  #     - name: Build Android APK
  #       run: flutter build apk --release

  #     # Upload the APK as an artifact
  #     - name: Upload Android APK
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-android
  #         path: build/app/outputs/flutter-apk/app-release.apk

  # # Job to build the iOS application
  # build-ios:
  #   runs-on: macos-latest # iOS builds require macOS

  #   steps:
  #     # Checks-outs your repository
  #     - uses: actions/checkout@v4

  #     # Sets up the Flutter SDK
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         channel: 'stable'
  #         flutter-version-file: flutter/pubspec.yaml
  #         cache: true

  #     # Gets the Flutter dependencies
  #     - name: Get Flutter dependencies
  #       run: flutter pub get

  #     # Builds the iOS release application (without code signing)
  #     - name: Build iOS release
  #       run: flutter build ios --release --no-codesign

  #     # Package the iOS build
  #     - name: Package iOS build
  #       run: |
  #         cd build/flutter/ios/iphoneos
  #         zip -r ../../../../release-ios.zip .

  #     # Upload the iOS build as an artifact
  #     - name: Upload iOS artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-ios
  #         path: release-ios.zip
