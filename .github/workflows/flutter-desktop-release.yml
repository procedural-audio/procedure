name: Build Procedure

# Controls when the workflow will run
on:
  push:
    tags:
      - 'v*'

env:
  LATEST_RELEASE_TAG: latest

jobs:
  # Ensure the GitHub Release for this tag exists so downstream jobs can attach artifacts
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure release exists for tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TARGET_TAG="${{ github.ref_name }}"
          LATEST_TAG="${{ env.LATEST_RELEASE_TAG }}"

          if gh release view "$TARGET_TAG" >/dev/null 2>&1; then
            echo "Release $TARGET_TAG already exists"
          else
            gh release create "$TARGET_TAG" --generate-notes --target "$GITHUB_SHA"
          fi

          if gh release view "$LATEST_TAG" >/dev/null 2>&1; then
            gh release edit "$LATEST_TAG" --target "$GITHUB_SHA" --notes "Latest build synced from $TARGET_TAG"
          else
            gh release create "$LATEST_TAG" --target "$GITHUB_SHA" --title "Latest Procedure build" --notes "Latest build synced from $TARGET_TAG"
          fi

  # Job to build the macOS application
  build-macos:
    needs: prepare-release
    runs-on: macos-latest # Use the latest available macOS runner
    defaults:
      run:
        working-directory: flutter

    steps:
      # Checks-outs your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Sets up the Flutter SDK for use in the workflow
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # Use the stable channel of Flutter
          flutter-version-file: flutter/pubspec.yaml
          cache: true

      # Gets the Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Builds the macOS release application
      - name: Build macOS release
        run: flutter build macos --release

      # Package the release build
      - name: Package macOS release
        run: |
          cd build/macos/Build/Products/Release
          hdiutil create -volname "procedure" -srcfolder procedure.app -ov -format UDZO ../../../../procedure-macos.dmg

      # Upload to GitHub release
      - name: Upload to GitHub Release
        run: |
          gh release upload ${{ github.ref_name }} build/procedure-macos.dmg --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to static latest release
        run: |
          gh release upload "${{ env.LATEST_RELEASE_TAG }}" build/procedure-macos.dmg --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job to build the Windows application
  build-windows-x64:
    needs: prepare-release
    runs-on: windows-latest
    defaults:
      run:
        working-directory: flutter

    steps:
      # Checks-outs your repository
      - uses: actions/checkout@v4

      # Sets up the Flutter SDK
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version-file: flutter/pubspec.yaml
          cache: true

      # Gets the Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Builds the Windows release application
      - name: Build Windows release
        run: flutter build windows --release

      # Package the release build
      - name: Package Windows release
        run: |
          cd build/windows/x64/runner/Release
          7z a ../../../../procedure-windows-x64.zip .

      # Upload to GitHub release
      - name: Upload to GitHub Release
        run: |
          gh release upload ${{ github.ref_name }} build/procedure-windows-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to static latest release
        run: |
          gh release upload "${{ env.LATEST_RELEASE_TAG }}" build/procedure-windows-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job to build the Linux x64 application
  build-linux-x64:
    needs: prepare-release
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter

    steps:
      # Checks-outs your repository
      - uses: actions/checkout@v4

      # Sets up the Flutter SDK
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version-file: flutter/pubspec.yaml
          cache: true

      # Install Linux dependencies
      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libasound2-dev libjack-jackd2-dev
          sudo apt-get install -y libwebkit2gtk-4.0-dev || sudo apt-get install -y libwebkit2gtk-4.1-dev
          if ! pkg-config --exists webkit2gtk-4.0; then
            if pkg-config --exists webkit2gtk-4.1; then
              pc_dir=$(pkg-config --variable=pcfiledir webkit2gtk-4.1)
              sudo ln -sf "${pc_dir}/webkit2gtk-4.1.pc" "${pc_dir}/webkit2gtk-4.0.pc"
            fi
          fi

      # Gets the Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Builds the Linux release application
      - name: Build Linux release
        run: flutter build linux --release

      # Package the release build
      - name: Package Linux release
        run: |
          cd build/linux/x64/release/
          zip -r ../../../procedure-linux-x64.zip bundle

      # Upload to GitHub release
      - name: Upload to GitHub Release
        run: |
          gh release upload ${{ github.ref_name }} build/procedure-linux-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to static latest release
        run: |
          gh release upload "${{ env.LATEST_RELEASE_TAG }}" build/procedure-linux-x64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job to build the Linux ARM64 application
  # build-linux-arm64:
  #   runs-on: ubuntu-24.04-arm
  #   defaults:
  #     run:
  #       working-directory: flutter

  #   steps:
  #     # Checks-outs your repository
  #     - uses: actions/checkout@v4

  #     # Sets up the Flutter SDK
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         channel: 'stable'
  #         flutter-version-file: flutter/pubspec.yaml
  #         cache: true

  #     # Install Linux dependencies
  #     - name: Install Linux dependencies
  #       run: |
  #         sudo apt-get update -y
  #         sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

  #     # Gets the Flutter dependencies
  #     - name: Get Flutter dependencies
  #       run: flutter pub get

  #     # Builds the Linux release application
  #     - name: Build Linux release
  #       run: flutter build linux --release

  #     # Package the release build
  #     - name: Package Linux release
  #       run: |
  #         cd build/linux/arm64/release/
  #         zip -r ../../../procedure-linux-arm64.zip bundle

  #     # Upload to GitHub release
  #     - name: Upload to GitHub Release
  #       run: |
  #         gh release upload ${{ github.ref_name }} build/procedure-linux-arm64.zip --clobber
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # # Job to build the Android APK
  # build-android:
  #   runs-on: ubuntu-latest # Use the latest available Ubuntu runner

  #   steps:
  #     # Checks-outs your repository
  #     - uses: actions/checkout@v4

  #     # Sets up the Flutter SDK
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         channel: 'stable'
  #         flutter-version-file: flutter/pubspec.yaml
  #         cache: true

  #     # Gets the Flutter dependencies
  #     - name: Get Flutter dependencies
  #       run: flutter pub get

  #     # Builds the Android APK
  #     - name: Build Android APK
  #       run: flutter build apk --release

  #     # Upload the APK as an artifact
  #     - name: Upload Android APK
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-android
  #         path: build/app/outputs/flutter-apk/app-release.apk

  # # Job to build the iOS application
  # build-ios:
  #   runs-on: macos-latest # iOS builds require macOS

  #   steps:
  #     # Checks-outs your repository
  #     - uses: actions/checkout@v4

  #     # Sets up the Flutter SDK
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         channel: 'stable'
  #         flutter-version-file: flutter/pubspec.yaml
  #         cache: true

  #     # Gets the Flutter dependencies
  #     - name: Get Flutter dependencies
  #       run: flutter pub get

  #     # Builds the iOS release application (without code signing)
  #     - name: Build iOS release
  #       run: flutter build ios --release --no-codesign

  #     # Package the iOS build
  #     - name: Package iOS build
  #       run: |
  #         cd build/flutter/ios/iphoneos
  #         zip -r ../../../../release-ios.zip .

  #     # Upload the iOS build as an artifact
  #     - name: Upload iOS artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: release-ios
  #         path: release-ios.zip
