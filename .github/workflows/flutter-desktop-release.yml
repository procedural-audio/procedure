# This GitHub Actions workflow uses a matrix strategy to build and package a
# Flutter desktop application for Windows, macOS, and Linux on every new tag.

name: Build Flutter Desktop App (Matrix)

# Controls when the workflow will run
on:
  push:
    tags:
      - 'v*' # Triggers the workflow on new version tags (e.g., v1.0.0, v2.1.3)

jobs:
  build:
    # The strategy matrix defines the different configurations to run the job with.
    # In this case, we are defining a configuration for each target platform.
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: macos
            package_command: 'cd build/macos/Build/Products/Release && zip -r ../../../../release-macos.zip .'
            artifact_path: release-macos.zip
          - os: windows-latest
            platform: windows
            package_command: 'cd build/windows/runner/Release && 7z a ../../../../release-windows.zip .'
            artifact_path: release-windows.zip
          - os: ubuntu-latest
            platform: linux
            package_command: 'cd build/linux/x64/release/bundle && zip -r ../../../../../release-linux.zip .'
            artifact_path: release-linux.zip

    # The job will run on the operating system defined in the matrix
    runs-on: ${{ matrix.os }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Sets up the Flutter SDK for use in the workflow
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # Use the stable channel of Flutter

      # Install Linux-specific dependencies only when running on Ubuntu
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

      # Gets the Flutter dependencies (common for all platforms)
      - name: Get Flutter dependencies
        run: flutter pub get

      # Builds the release application for the platform specified in the matrix
      - name: Build ${{ matrix.platform }} release
        run: flutter build ${{ matrix.platform }} --release

      # Packages the release build using the command specified in the matrix
      - name: Package ${{ matrix.platform }} release
        run: ${{ matrix.package_command }}

      # Uploads the packaged build as an artifact. The artifact name will be
      # based on the platform (e.g., release-macos, release-windows).
      - name: Upload ${{ matrix.platform }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: ${{ matrix.artifact_path }}
